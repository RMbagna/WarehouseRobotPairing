<div style="width: 100%; height: 100%; position: relative; background: white; overflow: hidden">
    <!-- Top navigation bar -->
    <div style="width: 1440px; height: 94px; padding-left: 100px; padding-right: 100px; left: 0px; top: 0px; position: absolute; justify-content: space-between; align-items: center; display: inline-flex">
        <!-- Navigation links -->
        <div style="justify-content: flex-start; align-items: flex-start; gap: 52px; display: flex">
            <a href="Home-Page.html" style="text-decoration: none;">
            <div data-status="Off" style="padding-bottom: 4px; justify-content: flex-start; align-items: flex-start; gap: 10px; display: flex">
            <div style="color: #333333; font-size: 20px; font-family: Sarabun; font-weight: 400; line-height: 32px; word-wrap: break-word">Home</div>
            </div>
            </a>
            <a href="Background-Page.html" style="text-decoration: none;">
            <div data-status="Off" style="padding-bottom: 4px; justify-content: flex-start; align-items: flex-start; gap: 10px; display: flex">
            <div style="color: #333333; font-size: 20px; font-family: Sarabun; font-weight: 400; line-height: 32px; word-wrap: break-word">Background</div>
            </div>
            </a>
             <a href="https://www.clemson.edu/cecas/departments/me/research/labs/i2r.html" style="text-decoration: none;">
                <div data-status="Off" style="padding-bottom: 4px; justify-content: flex-start; align-items: flex-start; gap: 10px; display: flex">
                <div style="color: #333333; font-size: 20px; font-family: Sarabun; font-weight: 400; line-height: 32px; word-wrap: break-word">About Us</div>
            </div>
            </a>
            </div>
             <!-- Quit button -->
        <a href="End-Page.html"  style="text-decoration: none;">
      <div style="width: 129px; height: 54px; padding-left: 24px; padding-right: 24px; background: rgba(246.50, 31.84, 31.84, 0.77); border-radius: 32px; justify-content: center; align-items: center; gap: 8px; display: flex">
        <div style="flex-direction: column; justify-content: center; align-items: center; display: inline-flex">
        <div style="justify-content: flex-start; align-items: flex-start; gap: 8px; display: inline-flex">
        <div style="color: #FAEEEE; font-size: 16px; font-family: Sarabun; font-weight: 700; line-height: 24px; word-wrap: break-word">Quit</div>
        </div>
        </div>
      </div>
      </a>
      </div>
      <script>
        function clearLocalStorage() {
            localStorage.clear();
            console.log("LocalStorage has been cleared");
        }
        </script>
    <!-- Main content area -->
    <div style="width: 1440px; height: 1024px; left: 0px; top: 94px; position: absolute">
        <!-- Right side content -->
        <div style="width: 608px; height: 1024px; left: 732px; top: 0px; position: absolute">
            <div style="width: 1036px; height: 1024px; left: -328px; top: 0px; position: absolute; background: rgba(244, 101, 48, 0.12)"></div>
            <!-- Thank You text -->
            <div style="left: 231px; top: 105px; position: absolute; color: #333333; font-size: 44px; font-family: Sarabun; font-weight: 700; line-height: 72px; word-wrap: break-word">Thank You!</div>
            <!-- Description text -->
            <!-- <div style="width: 616px; height: 359px; left: 63px; top: 116px; position: absolute; color: #333333; font-size: 22px; font-family: Sarabun; font-weight: 400; line-height: 72px; word-wrap: break-word"><br/>Thank you for participating! Your decisions help improve human-robot collaboration for the future. We appreciate your time and effort!</div>
             -->
            <!-- Satisfaction buttons -->
            <div style="width: 555px; left: 84px; top: 261px; position: absolute; color: #333333; font-size: 28px; font-family: Sarabun; font-weight: 700; line-height: 45px; word-wrap: break-word">
                How satisfied are you with your robot pairing results?
            </div>
            
            <!-- Dissatisfied button -->
            <a href="#" onclick="submitSatisfaction('Dissatisfied')" style="text-decoration:none;">
                <div style="width: 376px; height: 54px; padding-left: 24px; padding-right: 24px; left: 166px; top: 501px; position: absolute; background: #1B3360; border-radius: 32px; flex-direction: column; justify-content: center; align-items: center; display: inline-flex">
                    <div style="flex-direction: column; justify-content: center; align-items: center; display: flex">
                        <div style="justify-content: flex-start; align-items: flex-start; gap: 8px; display: inline-flex">
                            <div style="color: white; font-size: 16px; font-family: Sarabun; font-weight: 700; line-height: 24px; word-wrap: break-word">Dissatisfied, the model is not Human-Centric</div>
                        </div>
                    </div>
                </div>
            </a>
            
            <!-- Marginally dissatisfied button -->
            <a href="#" onclick="submitSatisfaction('Marginally dissatisfied')" style="text-decoration:none;">
                <div style="width: 376px; height: 54px; padding-left: 24px; padding-right: 24px; left: 166px; top: 582px; position: absolute; background: #1B3360; border-radius: 32px; flex-direction: column; justify-content: center; align-items: center; display: inline-flex">
                    <div style="flex-direction: column; justify-content: center; align-items: center; display: flex">
                        <div style="justify-content: flex-start; align-items: flex-start; gap: 8px; display: inline-flex">
                            <div style="color: white; font-size: 16px; font-family: Sarabun; font-weight: 700; line-height: 24px; word-wrap: break-word">Marginally dissatisfied, slightly Human-Centric</div>
                        </div>
                    </div>
                </div>
            </a>
            
            <!-- Marginally satisfied button -->
            <a href="#" onclick="submitSatisfaction('Marginally satisfied')" style="text-decoration:none;">
                <div style="width: 376px; height: 54px; padding-left: 24px; padding-right: 24px; left: 166px; top: 663px; position: absolute; background: #1B3360; border-radius: 32px; flex-direction: column; justify-content: center; align-items: center; display: inline-flex">
                    <div style="flex-direction: column; justify-content: center; align-items: center; display: flex">
                        <div style="justify-content: flex-start; align-items: flex-start; gap: 8px; display: inline-flex">
                            <div style="color: white; font-size: 16px; font-family: Sarabun; font-weight: 700; line-height: 24px; word-wrap: break-word">Marginally satisfied, almost Human-Centric</div>
                        </div>
                    </div>
                </div>
            </a>
            
            <!-- Satisfied button -->
            <a href="#" onclick="submitSatisfaction('Satisfied')" style="text-decoration:none;">
                <div style="width: 376px; height: 54px; padding-left: 24px; padding-right: 24px; left: 166px; top: 744px; position: absolute; background: #1B3360; border-radius: 32px; flex-direction: column; justify-content: center; align-items: center; display: inline-flex">
                    <div style="flex-direction: column; justify-content: center; align-items: center; display: flex">
                        <div style="justify-content: flex-start; align-items: flex-start; gap: 8px; display: inline-flex">
                            <div style="color: white; font-size: 16px; font-family: Sarabun; font-weight: 700; line-height: 24px; word-wrap: break-word">Satisfied, the model is human-centric</div>
                        </div>
                    </div>
                </div>
            </a>
        </div>

        <!-- Left side content - DFT Radar Chart -->
        <!-- <div style="width: 659px; height: 870px; left: 100px; top: 77px; position: absolute; box-shadow: 0px 6px 40px rgba(56.52, 119.95, 178.50, 0.08); border-radius: 24px; background-color: #D9D9D9; overflow: hidden; display: flex; flex-direction: column; padding: 20px; box-sizing: border-box;">
            <h2 style="text-align: center; margin: 0 0 15px 0; color: #333; font-size: 24px;">Your Robot Preference Profile</h2>
             -->
            <!-- Radar Chart Container -->
            <!-- <div style="flex: 1; min-height: 0; position: relative;">
                <canvas id="radarChart" style="width: 100%; height: 100%; display: block;"></canvas>
            </div>
             -->
            <!-- DFT Parameters Display -->
            <!-- <div id="dftParameters" style="margin-top: 20px; padding: 15px; background: rgba(255, 255, 255, 0.7); border-radius: 12px; font-size: 14px;"> -->
                <!-- Parameters will be displayed here -->
            <!-- </div>
        </div> -->
          <!-- Left side content with image and text -->
        <div style="width: 659px; height: 870px; left: 100px; top: 77px; position: absolute; box-shadow: 0px 6px 40px rgba(56.52, 119.95, 178.50, 0.08)">
            <div style="width: 660px; height: 870px; left: 0px; top: 0px; position: absolute; background: #D9D9D9; border-radius: 24px"></div>
            <img style="width: 659px; height: 870px; left: 0px; top: 0px; position: absolute; background: linear-gradient(0deg, rgba(0, 0, 0, 0.20) 0%, rgba(0, 0, 0, 0.20) 100%); border-radius: 24px" src="Figma\Version2\banner-composite-duo.jpg" />
            <!-- Main title text on the left side -->
            <div style="width: 596px; left: 41px; top: 523px; position: absolute; color: #EBF7FB; font-size: 64px; font-family: Sarabun; font-weight: 700; word-wrap: break-word">Human - Robot Interaction Study</div>
        </div>
    </div>
</div>

<!-- Load required libraries -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="dft.js"></script>

<script>
// Main execution when page loads
window.addEventListener('load', async function() {
    // 1. Load pairing data from localStorage
    const allPairingData = JSON.parse(localStorage.getItem('allPairingData')) || [];
    
    if (allPairingData.length === 0) {
        document.getElementById('dftParameters').innerHTML = 
            "<p>No pairing data available for analysis.</p>";
        return;
    }
    
    // 2. Initialize DFT model
    const dftModel = new DFTModel();
    
    // 3. Show loading state
    document.getElementById('dftParameters').innerHTML = 
        '<p>Analyzing your choices... <span class="loading-dots"></span></p>';
    
    // 4. Estimate parameters using RPy2 backend
    try {
        const success = await dftModel.estimateParameters(allPairingData);
        
        if (!success) {
            throw new Error("Parameter estimation failed");
        }
        
        // 5. Calculate results with estimated parameters
        const results = dftModel.calculate(allPairingData);
        
        // 6. Display parameters
        document.getElementById('dftParameters').innerHTML = `
            <h3 style="margin-top: 0; font-size: 16px;">DFT Analysis Results</h3>
            <p><strong>Sensitivity (φ1):</strong> ${results.parameters.phi1.toFixed(3)}</p>
            <p><strong>Memory (φ2):</strong> ${results.parameters.phi2.toFixed(3)}</p>
            <p><strong>Time Steps (τ):</strong> ${results.parameters.tau.toFixed(0)}</p>
            <p><strong>Attribute Weights:</strong></p>
            <ul style="margin-top: 5px; padding-left: 20px;">
                ${results.attributes.map((attr, i) => 
                    `<li>${attr}: ${results.parameters.beta_weights[i].toFixed(2)}</li>`
                ).join('')}
            </ul>
            <p><strong>Predicted Preferences:</strong></p>
            <ul style="margin-top: 5px; padding-left: 20px;">
                <li>Delivery: ${(results.choiceProbabilities[0]*100).toFixed(1)}%</li>
                <li>Inspection: ${(results.choiceProbabilities[1]*100).toFixed(1)}%</li>
                <li>Assembling: ${(results.choiceProbabilities[2]*100).toFixed(1)}%</li>
            </ul>
        `;
        
        // 7. Create radar chart
        const ctx = document.getElementById('radarChart').getContext('2d');
        new Chart(ctx, {
            type: 'radar',
            data: {
                labels: results.attributes,
                datasets: [
                    {
                        label: 'Delivery Robot',
                        data: results.roleAverages[0],
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        borderColor: 'rgb(255, 99, 132)',
                        pointBackgroundColor: 'rgb(255, 99, 132)',
                        borderWidth: 2
                    },
                    {
                        label: 'Inspection Robot',
                        data: results.roleAverages[1],
                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                        borderColor: 'rgb(54, 162, 235)',
                        pointBackgroundColor: 'rgb(54, 162, 235)',
                        borderWidth: 2
                    },
                    {
                        label: 'Assembling Robot',
                        data: results.roleAverages[2],
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        borderColor: 'rgb(75, 192, 192)',
                        pointBackgroundColor: 'rgb(75, 192, 192)',
                        borderWidth: 2
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    r: {
                        min: 0,
                        max: 1,
                        ticks: {
                            stepSize: 0.2
                        }
                    }
                },
                plugins: {
                    title: {
                        display: true,
                        text: 'Your Preferred Robot Attributes',
                        font: { size: 16 }
                    },
                    legend: {
                        position: 'bottom',
                        labels: {
                            font: {
                                size: 12
                            }
                        }
                    }
                }
            }
        });
        
    } catch (error) {
        console.error("Analysis error:", error);
        document.getElementById('dftParameters').innerHTML = `
            <p>Error analyzing your data: ${error.message}</p>
            <p>Showing simplified results instead.</p>
        `;
        
        // Fallback to simplified calculation
        const results = dftModel.calculate(allPairingData);
        
        // Create chart with fallback data
        const ctx = document.getElementById('radarChart').getContext('2d');
        new Chart(ctx, {
            type: 'radar',
            data: {
                labels: results.attributes,
                datasets: [
                    {
                        label: 'Delivery Robot',
                        data: results.roleAverages[0],
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        borderColor: 'rgb(255, 99, 132)',
                        borderWidth: 2
                    },
                    {
                        label: 'Inspection Robot',
                        data: results.roleAverages[1],
                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                        borderColor: 'rgb(54, 162, 235)',
                        borderWidth: 2
                    },
                    {
                        label: 'Assembling Robot',
                        data: results.roleAverages[2],
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        borderColor: 'rgb(75, 192, 192)',
                        borderWidth: 2
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    r: {
                        min: 0,
                        max: 1,
                        ticks: {
                            stepSize: 0.2
                        }
                    }
                }
            }
        });
    }
});

// Satisfaction submission function
function submitSatisfaction(rating) {
    try {
        const participantId = localStorage.getItem('participantId') || 'anonymous';
        const allPairingData = JSON.parse(localStorage.getItem('allPairingData')) || [];
        const dftResults = JSON.parse(localStorage.getItem('dftResults')) || {};
        
        // Prepare data to send
        const data = {
            participantId,
            rating,
            pairingData: allPairingData,
            dftResults
        };
        
        // Send to server (replace with your actual endpoint)
        axios.post('/api/satisfaction', data)
            .then(response => {
                alert('Thank you for your feedback!');
                // Optionally clear localStorage after submission
                // localStorage.clear();
            })
            .catch(error => {
                console.error('Error submitting satisfaction:', error);
                alert('Feedback submission failed, but your results were saved.');
            });
            
        // Download data as CSV fallback
        downloadData(rating);
        
    } catch (error) {
        console.error('Error in submitSatisfaction:', error);
        alert('Error processing your feedback.');
    }
}

// Download data function
function downloadData(userRating) {
    const participantId = localStorage.getItem('participantId') || 'anonymous';
    const now = new Date();
    const dateTime = now.toISOString().replace(/[:.]/g, '-').split('T').join('_');
    
    // Get DFT results if available
    const dftResults = JSON.parse(localStorage.getItem('dftResults')) || {};
    
    // Prepare CSV content
    let csvContent = "participantId,DateTime,Role,Attribute,Value,UserRating,DFT_Probability\n";
    
    // Add pairing data
    const allPairingData = JSON.parse(localStorage.getItem('allPairingData')) || [];
    allPairingData.forEach(trial => {
        if (trial.choice && trial.robot1Attributes) {
            const attrs = trial[`robot${trial.choice}Attributes`];
            attrs.forEach((val, idx) => {
                const attrName = ['Energy','Pace','Safety','Reliability','Intelligence'][idx];
                csvContent += `${participantId},${dateTime},${trial.role},${attrName},${val},,,\n`;
            });
        }
    });
    
    // Add DFT results
    if (dftResults.M) {
        const roles = ['Delivery', 'Inspection', 'Assembling'];
        roles.forEach((role, idx) => {
            dftResults.M[idx].forEach((val, attrIdx) => {
                const attrName = ['Energy','Pace','Safety','Reliability','Intelligence'][attrIdx];
                csvContent += `${participantId},${dateTime},${role},${attrName},${val},${userRating},${dftResults.choice_probs[idx]}\n`;
            });
        });
    }
    
    // Create and download CSV
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = `RobotChoice-${dateTime}-${participantId}.csv`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}
</script>

<style>
.loading-dots::after {
    content: '.';
    animation: dots 1.5s steps(5, end) infinite;
}

@keyframes dots {
    0%, 20% { content: '.'; }
    40% { content: '..'; }
    60% { content: '...'; }
    80%, 100% { content: ''; }
}
</style>